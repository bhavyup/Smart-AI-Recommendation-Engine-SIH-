<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Smart Allocation Engine - PM Internship Scheme</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <script src="/static/js/i18n.js"></script>

    <style>
        :root {
            --bg-grad-1: #1f2937;
            /* slate-800 */
            --bg-grad-2: #0f172a;
            /* slate-900 */
            --glass: #ffffff;
            --primary: #2563eb;
            /* blue-600 */
            --primary-2: #1e40af;
            /* blue-800 */
            --accent: #22c55e;
            /* green-500 */
            --warning: #f59e0b;
            /* amber-500 */
            --danger: #ef4444;
            /* red-500 */
            --muted: #94a3b8;
            /* slate-400 */
            --muted-2: #cbd5e1;
            /* slate-300 */
            --bg-dark-1: #071128;
            --bg-dark-2: #0b2a3a;
            --accent-cyan: #0ea5e9;
            --accent-green: #22c55e;
            --accent-purple: #7c3aed;
            --bg-node-blur: 160px;
            --bg-overlay-opacity: 0.30;
            --noise-opacity: 0.06;
            --drift-duration: 30s;
        }

        /* full-screen background container (behind everything) */
        .bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            min-height: 100vh;
            pointer-events: none;
            background: linear-gradient(135deg, var(--bg-dark-1), var(--bg-dark-2));
            isolation: isolate;
            overflow: hidden;
        }

        /* colorful radial nodes (soft clouds) */
        .bg-node {
            position: absolute;
            border-radius: 50%;
            filter: blur(var(--bg-node-blur));
            transform-origin: center;
            mix-blend-mode: screen;
            opacity: 0.98;
            will-change: transform, opacity;
        }

        /* individual nodes (tweak positions if you want) */
        .bg-node.node-a {
            width: 1100px;
            height: 700px;
            left: -8%;
            top: -6%;
            background: radial-gradient(circle at 30% 30%, rgba(14, 165, 233, 0.95) 0%, rgba(14, 165, 233, 0.20) 35%, transparent 75%);
            animation: driftA var(--drift-duration) ease-in-out infinite;
        }

        .bg-node.node-b {
            width: 1000px;
            height: 900px;
            right: -6%;
            bottom: -8%;
            background: radial-gradient(circle at 60% 60%, rgba(34, 197, 94, 0.95) 0%, rgba(34, 197, 94, 0.20) 38%, transparent 74%);
            animation: driftB calc(var(--drift-duration) * 1.1) ease-in-out infinite;
        }

        .bg-node.node-c {
            width: 700px;
            height: 700px;
            right: 6%;
            top: 8%;
            background: radial-gradient(circle at 50% 50%, rgba(124, 58, 237, 0.92) 0%, rgba(124, 58, 237, 0.18) 35%, transparent 75%);
            animation: driftC calc(var(--drift-duration) * 0.9) ease-in-out infinite;
        }

        /* gentle dark overlay so your glass panels pop */
        .bg-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(0, 0, 0, var(--bg-overlay-opacity)), rgba(0, 0, 0, 0.12));
            backdrop-filter: blur(6px) saturate(1.05);
            -webkit-backdrop-filter: blur(6px) saturate(1.05);
            z-index: 1;
            mix-blend-mode: normal;
        }

        /* fine-grain noise (SVG data-URL) */
        .bg-noise {
            position: absolute;
            inset: 0;
            z-index: 2;
            pointer-events: none;
            background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200'><filter id='n'><feTurbulence baseFrequency='0.85' numOctaves='1' stitchTiles='stitch'/><feColorMatrix type='saturate' values='0'/><feComponentTransfer><feFuncA type='table' tableValues='0 0.06'/></feComponentTransfer></filter><rect width='100%' height='100%' filter='url(%23n)' /></svg>");
            opacity: var(--noise-opacity);
            mix-blend-mode: overlay;
            transform: scale(1.5);
        }

        /* animations for the nodes */
        @keyframes driftA {
            0% {
                transform: translate3d(-2%, -1%, 0) scale(1);
            }

            50% {
                transform: translate3d(3%, 2%, 0) scale(1.02);
            }

            100% {
                transform: translate3d(-2%, -1%, 0) scale(1);
            }
        }

        @keyframes driftB {
            0% {
                transform: translate3d(1%, 2%, 0) scale(1);
            }

            50% {
                transform: translate3d(-3%, -2%, 0) scale(1.03);
            }

            100% {
                transform: translate3d(1%, 2%, 0) scale(1);
            }
        }

        @keyframes driftC {
            0% {
                transform: translate3d(0%, -1%, 0) scale(1);
            }

            50% {
                transform: translate3d(2%, 3%, 0) scale(1.01);
            }

            100% {
                transform: translate3d(0%, -1%, 0) scale(1);
            }
        }

        /* accessibility: disable motion for users who prefer reduced motion */
        @media (prefers-reduced-motion: reduce) {
            .bg-node {
                animation: none !important;
                transition: none !important;
            }
        }

        /* small responsive tuning */
        @media (max-width: 900px) {
            .bg-node.node-a {
                width: 800px;
                height: 500px;
                left: -18%;
                top: -14%;
            }

            .bg-node.node-b {
                width: 800px;
                height: 700px;
                right: -18%;
                bottom: -16%;
            }

            .bg-node.node-c {
                width: 520px;
                height: 520px;
                right: 6%;
                top: 6%;
            }

            .bg-noise {
                transform: scale(2);
                opacity: calc(var(--noise-opacity) * 0.8);
            }
        }


        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        html::-webkit-scrollbar {
            display: none;
        }

        html {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            scrollbar-gutter: stable both-edges;
        }

        .main-container {
            background: transparent;
            backdrop-filter: blur(14px) saturate(140%);
            -webkit-backdrop-filter: blur(14px) saturate(140%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 18px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.35);
            margin: 0 auto;
            /* remove vertical margins that trigger tiny overflow */
            padding: 28px;
            max-width: 1200px;
            color: #e2e8f0;
        }

        .main-container-p0 {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(14px) saturate(140%);
            -webkit-backdrop-filter: blur(14px) saturate(140%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 18px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.35);
            margin: 0 auto;
            /* remove vertical margins that trigger tiny overflow */
            padding: 0;
            max-width: 1200px;
            color: #e2e8f0;
        }

        /* Give the page breathing space without adding overflow */
        .container-fluid {
            padding-block: clamp(12px, 3vh, 24px);
            padding-inline: 12px;
            background: transparent !important;
            min-height: 100vh;
        }

        

        .header h1 {
            font-weight: 800;
            letter-spacing: .3px;
            background: linear-gradient(90deg, #93c5fd, #d8b4fe, #86efac);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 6px;
        }

        .header p {
            color: #cbd5e1;
            font-size: 1.05rem;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            padding: 24px;
            padding-bottom: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        }

        .section-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-head h3 {
            margin: 0;
            font-weight: 700;
            color: #e5e7eb;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-2));
            border: none;
            border-radius: 10px;
            padding: 12px 26px;
            font-weight: 700;
            letter-spacing: .2px;
            transition: transform .15s ease, box-shadow .2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.35);
        }

        .btn-success {
            background: linear-gradient(135deg, #16a34a, #065f46);
            border: none;
            border-radius: 10px;
            font-weight: 700;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #b45309);
            border: none;
            border-radius: 10px;
            font-weight: 700;
            color: #0f172a;
        }

        .btn-outline-primary {
            border-radius: 10px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            color: #e2e8f0;
        }

        .btn-outline-primary:hover {
            background: rgba(148, 163, 184, 0.12);
        }

        .btn-ghost {
            border: 1px dashed rgba(148, 163, 184, 0.45);
            color: #e2e8f0;
            background: transparent;
            border-radius: 10px;
        }

        .btn-ghost:hover {
            background: rgba(148, 163, 184, 0.12);
        }

        .form-label {
            color: #e2e8f0;
            font-weight: 700;
        }

        .form-control,
        .form-select {
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.35);
            border: 1px solid rgba(148, 163, 184, 0.35);
            color: #e2e8f0;
        }

        .form-control::placeholder {
            color: #94a3b8;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #60a5fa;
            box-shadow: 0 0 0 .2rem rgba(96, 165, 250, 0.25);
        }

        .email-step {
            background: rgba(15, 23, 42, 0.35);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            margin-bottom: 10px;
        }

        /* Recommendations wrapper matches glass look */
        .recommendations-section {
            display: none;
            margin-top: 30px;
        }

        .rec-shell {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            margin: 0 auto;
        }

        .rec-header {
            background: linear-gradient(135deg, rgba(148, 163, 184, 0.15), rgba(59, 130, 246, 0.12));
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            padding: 16px 20px;
        }

        .rec-header h3 {
            color: #e2e8f0;
            font-weight: 800;
            letter-spacing: .2px;
        }

        .rec-list {
            padding: 16px;
        }

        /* Card */
        .recommendation-card {
            position: relative;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 14px;
            padding: 18px;
            margin: 12px 4px 18px;
            box-shadow: 0 12px 28px rgba(0, 0, 0, 0.22);
            color: #e2e8f0;
            transition: transform .15s ease, box-shadow .2s ease, border-color .2s;
        }

        .recommendation-card::before {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(300px 220px at 0% 0%, rgba(147, 197, 253, 0.12), transparent 60%),
                radial-gradient(260px 200px at 100% 0%, rgba(34, 197, 94, 0.10), transparent 55%);
            pointer-events: none;
            border-radius: inherit;
        }

        .recommendation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 36px rgba(0, 0, 0, 0.30);
            border-color: rgba(147, 197, 253, 0.25);
        }

        /* Top strip: score + badges */
        .rec-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .rec-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge.rural-friendly {
            background: linear-gradient(135deg, #16a34a, #065f46);
            border: 1px solid rgba(16, 185, 129, 0.45);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: .8rem;
            font-weight: 700;
            color: white;
        }

        .badge.diversity-badge {
            background: linear-gradient(135deg, #f59e0b, #b45309);
            border: 1px solid rgba(245, 158, 11, 0.45);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: .8rem;
            font-weight: 700;
            color: #0f172a;
        }

        /* Title + company */
        .rec-title {
            margin-bottom: 6px;
        }

        .company-name {
            color: #93c5fd;
            font-weight: 800;
            font-size: 1.12rem;
        }

        .internship-title {
            color: #e2e8f0;
            font-weight: 700;
        }

        /* Meta grid + score meter */
        .rec-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px 18px;
            color: #cbd5e1;
            margin: 10px 0 12px;
        }

        .rec-meter {
            margin: auto 0;
        }

        .meter {
            position: relative;
            height: 10px;
            width: 180px;
            background: rgba(148, 163, 184, 0.25);
            border-radius: 999px;
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.35);
        }

        .meter>.fill {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0%;
            background: linear-gradient(90deg, #22c55e, #60a5fa);
            transition: width .5s ease;
        }

        /* Skills chips */
        .skills-tags {
            margin: 12px 0 8px;
        }

        .chip {
            background: rgba(59, 130, 246, 0.15);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.35);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: .85rem;
            margin-right: 8px;
            margin-bottom: 6px;
            display: inline-block;
        }

        /* Reasons in a glass panel */
        .match-reasons {
            background: rgba(30, 58, 138, 0.22);
            border: 1px solid rgba(59, 130, 246, 0.22);
            border-radius: 12px;
            padding: 12px 14px;
            margin-top: 8px;
        }

        .match-reasons h6 {
            color: #93c5fd;
            font-weight: 800;
            margin-bottom: 6px;
        }

        /* Footer actions */
        .rec-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-outline-primary.btn-sm {
            border-color: rgba(148, 163, 184, 0.5);
            color: #e2e8f0;
        }

        .btn-outline-primary.btn-sm:hover {
            background: rgba(148, 163, 184, 0.12);
        }

        .match-score {
            background: linear-gradient(135deg, #10b981, #047857);
            color: white;
            padding: 6px 12px;
            border-radius: 999px;
            font-weight: 800;
            font-size: .9rem;
        }

        .company1-name {
            color: #93c5fd;
            font-weight: 800;
            font-size: 1.15rem;
            margin-bottom: 4px;
        }

        .internship1-title {
            color: #e2e8f0;
            font-weight: 700;
        }

        .internship-details {
            color: #cbd5e1;
            margin-bottom: 12px;
        }

        .skill-tag {
            background: rgba(59, 130, 246, 0.15);
            color: #93c5fd;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: .85rem;
            margin-right: 8px;
            margin-bottom: 6px;
            display: inline-block;
            border: 1px solid rgba(59, 130, 246, 0.35);
        }

        .match-r1easons {
            background: rgba(30, 58, 138, 0.25);
            padding: 14px;
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.25);
        }

        .match-re1asons h6 {
            color: #93c5fd;
            font-weight: 800;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #e2e8f0;
        }

        .spinner-border {
            color: #93c5fd;
        }

        .badge.rural-1friendly {
            background: linear-gradient(135deg, #16a34a, #065f46);
            border: 1px solid rgba(16, 185, 129, 0.45);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: .8rem;
            font-weight: 700;
            color: white;
        }

        .badge.diver1sity-badge {
            background: linear-gradient(135deg, #f59e0b, #b45309);
            border: 1px solid rgba(245, 158, 11, 0.45);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: .8rem;
            font-weight: 700;
            color: #0f172a;
        }

        .toast-container {
            z-index: 1080;
        }

        .toast {
            border-radius: 12px;
            overflow: hidden;
        }

        .rec-list>.recommendation-card+.recommendation-card {
            margin-top: 14px;
        }

        .rec-title .company-name {
            margin-top: 2px;
        }

        .rec-title .internship-title {
            margin-top: -2px;
        }

        /* Details Modal - glass vibe */
        .modal-glass .modal-content {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(16px) saturate(140%);
            -webkit-backdrop-filter: blur(16px) saturate(140%);
            border: 1px solid rgba(148, 163, 184, 0.25);
            border-radius: 16px;
            color: #e2e8f0;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
        }

        .modal-glass .modal-header {
            border-bottom: 1px solid rgba(148, 163, 184, 0.25);
            background: linear-gradient(135deg, rgba(148, 163, 184, 0.18), rgba(59, 130, 246, 0.12));
        }

        .modal-glass .modal-title {
            font-weight: 800;
            letter-spacing: .2px;
        }

        .modal-glass .modal-body .meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px 18px;
            color: #cbd5e1;
        }

        .modal-glass .chip {
            background: rgba(59, 130, 246, 0.15);
            color: #93c5fd;
            border: 1px solid rgba(59, 130, 246, 0.35);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: .85rem;
            margin-right: 8px;
            margin-bottom: 6px;
            display: inline-block;
        }

        .modal-glass .reasons {
            background: rgba(30, 58, 138, 0.22);
            border: 1px solid rgba(59, 130, 246, 0.22);
            border-radius: 12px;
            padding: 12px 14px;
        }

        .modal-glass .badge.rural-friendly {
            background: linear-gradient(135deg, #16a34a, #065f46);
            border: 1px solid rgba(16, 185, 129, 0.45);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: .8rem;
            font-weight: 700;
            color: white;
        }

        .modal-glass .badge.diversity-badge {
            background: linear-gradient(135deg, #f59e0b, #b45309);
            border: 1px solid rgba(245, 158, 11, 0.45);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: .8rem;
            font-weight: 700;
            color: #0f172a;
        }

        /* Shortlist Drawer - glass theme */
        .offcanvas-glass {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(16px) saturate(140%);
            -webkit-backdrop-filter: blur(16px) saturate(140%);
            color: #e2e8f0;
            border-left: 1px solid rgba(148, 163, 184, 0.25);
        }

        .offcanvas-glass .offcanvas-header {
            border-bottom: 1px solid rgba(148, 163, 184, 0.25);
            background: linear-gradient(135deg, rgba(148, 163, 184, 0.18), rgba(59, 130, 246, 0.12));
        }

        .offcanvas-glass .offcanvas-title {
            font-weight: 800;
            letter-spacing: .2px;
        }

        .offcanvas-glass .list-group-item {
            background: transparent;
            color: #e2e8f0;
            border-color: rgba(255, 255, 255, 0.10);
        }

        .offcanvas-glass .list-group-item:hover {
            background: rgba(148, 163, 184, 0.08);
        }

        .offcanvas-glass .badge {
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 12px;
                padding: 16px;
            }

            .form-section {
                padding: 16px;
            }

            .recommendation-card {
                padding: 16px;
            }
        }
    </style>
</head>

<body>
    <div class="bg" aria-hidden="true">
        <div class="bg-node node-a"></div>
        <div class="bg-node node-b"></div>
        <div class="bg-node node-c"></div>
        <div class="bg-overlay"></div>
        <div class="bg-noise"></div>
    </div>
    <div class="container-fluid">
        <div class="main-container">
            <div class="header">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h1><i class="fas fa-brain"></i> AI Smart Allocation Engine</h1>
                    <div class="d-flex gap-2 align-items-center">
                        <a href="/" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-home"></i> Home
                        </a>
                        <button id="btnViewShortlist" class="btn btn-outline-primary btn-sm" style="display:none;">
                            <i class="fas fa-bookmark"></i> Shortlist
                            <span id="shortBadge" class="badge rounded-pill bg-success ms-1"
                                style="display:none;">0</span>
                        </button>
                    </div>
                </div>
                <p>PM Internship Scheme • Find Your Perfect Internship Match</p>
            </div>

            <div class="form-section">
                <div class="section-head">
                    <h3><i class="fas fa-user-edit me-2"></i> Candidate Information</h3>
                    <button id="btnChangeEmail" class="btn btn-ghost btn-sm" style="display:none;">
                        <i class="fas fa-envelope-open-text"></i> Change Email
                    </button>
                </div>

                <!-- Step 1: Email Lookup -->
                <div id="emailStep" class="email-step">
                    <div class="row g-3">
                        <div class="d-flex flex-column">
                            <label class="form-label">Email:<span class="text-danger">*</span></label>
                            <div class="form-text text-muted" style="margin-top: -5px;font-size: small;">Lookup starts
                                automatically while typing</div>
                            <div class="d-flex gap-2 w-100 align-items-center">
                                <input type="email" class="form-control w-50" id="emailLookup"
                                    placeholder="you@example.com" autocomplete="email" inputmode="email" required
                                    pattern="^[^\\s@]+@[^\\s@]+\\.[^\\s@]{2,}$"
                                    style="margin-top: 2px;background-color:#0f172a59;color: #e5e7eb;outline: none;padding-right: 0.75rem;padding-left: 0.375rem;" />
                                <div id="lookupStatus"></div>
                                <div id="lookupSpinner" class="spinner-border spinner-border-sm text-primary"
                                    role="status" style="display:none;">
                                </div>
                            </div>
                            <div class="invalid-feedback">Please enter a valid email like name@example.com</div>
                        </div>

                        <div class="col-md-4 d-flex align-items-center">
                            <div class="d-flex align-items-center">

                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                    <button id="btnShowRecord" class="btn btn-outline-primary" style="display:none;">
                        <i class="fas fa-folder-open"></i> Show Record
                    </button>
                    <button id="btnCreateRecord" class="btn btn-success" style="display:none;">
                        <i class="fas fa-plus"></i> Create Record
                    </button>
                </div>
            </div>

            <!-- Step 2: Details Form -->
            <form id="candidateForm" style="display:none;">
                <input type="hidden" id="mode" value=""> <!-- existing | create -->

                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label">Full Name:<span class="text-danger">*</span></label>
                        <input type="text" class="form-control d-flex align-items-center"
                            style="background-color: #0f172a59;color: white;" id="name" name="name" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Email:<span class="text-danger">*</span></label>
                        <input type="email" class="form-control" style="background-color: #0f172a59;color: white;"
                            id="email" name="email" placeholder="you@example.com" required readonly>
                        <div class="form-text text-warning">Email is locked to prevent duplicates.</div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Education Level:<span class="text-danger">*</span></label>
                        <select class="form-select" id="education_level" name="education_level" required>
                            <option value="">Select Education Level</option>
                            <option value="Diploma">Diploma</option>
                            <option value="Bachelor">Bachelor's Degree</option>
                            <option value="Master">Master's Degree</option>
                            <option value="PhD">PhD</option>
                        </select>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="first_generation_graduate"
                                name="first_generation_graduate">
                            <label class="form-check-label" for="first_generation_graduate">First Generation
                                Graduate</label>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-4">
                        <label class="form-label">Skills:<span class="text-danger">*</span> (comma-separated)</label>
                        <input type="text" class="form-control" style="background-color: #0f172a59;color: white;"
                            id="skills" name="skills" placeholder="e.g., Python, JavaScript, Data Analysis" required>
                    </div>
                    <div class="col-md-6 mb-4">
                        <label class="form-label">Preferred Location:<span class="text-danger">*</span></label>
                        <select class="form-select" id="location" name="location" required>
                            <option value="">Select Location</option>
                            <option value="Bangalore">Bangalore</option>
                            <option value="Mumbai">Mumbai</option>
                            <option value="Delhi">Delhi</option>
                            <option value="Chennai">Chennai</option>
                            <option value="Hyderabad">Hyderabad</option>
                            <option value="Pune">Pune</option>
                            <option value="Kolkata">Kolkata</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-4">
                        <label class="form-label">Sector Interests:<span class="text-danger">*</span>
                            (comma-separated)</label>
                        <input type="text" class="form-control" style="background-color: #0f172a59;color: white;"
                            id="sector_interests" name="sector_interests"
                            placeholder="e.g., Technology, Finance, Healthcare" required>
                    </div>
                    <div class="col-md-6 mb-4">
                        <label class="form-label">Social Category:<span class="text-danger">*</span></label>
                        <select class="form-select" id="social_category" name="social_category">
                            <option value="">Select Category</option>
                            <option value="General">General</option>
                            <option value="SC">SC</option>
                            <option value="ST">ST</option>
                            <option value="OBC">OBC</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="prefers_rural" name="prefers_rural">
                            <label class="form-check-label" for="prefers_rural">Prefer Rural Opportunities</label>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="from_rural_area" name="from_rural_area">
                            <label class="form-check-label" for="from_rural_area">From Rural Area</label>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">

                    </div>
                </div>

                <div class="d-flex flex-wrap gap-2 justify-content-center">
                    <button type="button" id="btnFindExistingMatches" class="btn btn-primary btn-lg"
                        style="display:none;">
                        <i class="fas fa-search"></i> Find My Internship Matches
                    </button>
                    <button type="button" id="btnUpdateAndFind" class="btn btn-warning hover:shadow-lg btn-lg"
                        style="display:none;">
                        <i class="fas fa-sync"></i> Update and Find My Internship Matches
                    </button>
                    <button type="button" id="btnRegisterAndFind" class="btn btn-success hover:shadow-lg btn-lg"
                        style="display:none;">
                        <i class="fas fa-paper-plane"></i> Register and Find My Internship Matches
                    </button>
                </div>
            </form>
        </div>
        <!-- Loading and Recommendations INSIDE the glass container for consistent look -->
        <div id="loadingSection" class="loading" style="display:none;">
            <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>
            <p class="mt-3">AI is analyzing your profile and finding the best matches...</p>
        </div>

        <div id="recommendationsSection" class="recommendations-section main-container-p0">
            <div class="rec-shell">
                <div class="rec-header">
                    <h3 class="mb-0"><i class="fas fa-star me-2"></i> Your Top Internship Matches</h3>
                </div>
                <div id="recommendationsContainer" class="rec-list"></div>
            </div>
        </div>
    </div> <!-- end .main-container -->

    <!-- Toasts -->
    <div class="position-fixed top-0 end-0 p-3 toast-container">
        <div id="toastContainer"></div>
    </div>

    <!-- Details Modal -->
    <div class="modal fade modal-glass" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-briefcase me-2"></i><span id="mdTitle">Internship</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <div class="company-name" id="mdCompany"></div>
                            <div class="text-info" id="mdSector"></div>
                        </div>
                        <div class="d-flex gap-2 flex-wrap" id="mdBadges"></div>
                    </div>

                    <div class="meta mb-3">
                        <div><strong><i class="fas fa-map-marker-alt"></i> Location:</strong> <span
                                id="mdLocation"></span></div>
                        <div><strong><i class="fas fa-graduation-cap"></i> Education:</strong> <span
                                id="mdEducation"></span></div>
                        <div><strong><i class="fas fa-calendar"></i> Duration:</strong> <span id="mdDuration"></span>
                        </div>
                        <div><strong><i class="fas fa-rupee-sign"></i> Stipend:</strong> <span id="mdStipend"></span>
                        </div>
                        <div><strong><i class="fas fa-users"></i> Capacity:</strong> <span id="mdCapacity"></span></div>
                    </div>

                    <div class="mb-2">
                        <strong>Required Skills:</strong><br />
                        <div id="mdSkills"></div>
                    </div>

                    <div class="reasons mt-3">
                        <h6><i class="fas fa-lightbulb"></i> Why This Match?</h6>
                        <div id="mdReasons"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btnShortlist" type="button" class="btn btn-outline-primary">
                        <i class="fas fa-bookmark"></i> Save to Shortlist
                    </button>
                    <button type="button" class="btn btn-success">
                        <i class="fas fa-paper-plane"></i> Apply Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shortlist Drawer -->
    <div class="offcanvas offcanvas-end offcanvas-glass" tabindex="-1" id="shortlistDrawer"
        aria-labelledby="shortlistLabel">
        <div class="offcanvas-header">
            <h5 id="shortlistLabel" class="offcanvas-title">
                <i class="fas fa-bookmark me-2"></i> Your Shortlist
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"
                aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div id="shortlistEmpty" class="text-warning-emphasis mb-2">No items yet. Save internships using “Save to
                Shortlist”.
            </div>
            <div id="shortlistList" class="list-group list-group-flush rounded-3"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Utilities
        const debounce = (fn, delay = 300) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), delay); }; };
        const qs = id => document.getElementById(id);
        const toArray = val => !val ? [] : Array.isArray(val) ? val : String(val).split(',').map(s => s.trim()).filter(Boolean);
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/;

        // Elements
        const emailStep = qs('emailStep');
        const emailLookup = qs('emailLookup');
        const lookupStatus = qs('lookupStatus');
        const lookupSpinner = qs('lookupSpinner');
        const btnShowRecord = qs('btnShowRecord');
        const btnCreateRecord = qs('btnCreateRecord');
        const btnChangeEmail = qs('btnChangeEmail');
        const invalidFeedback = emailStep.querySelector('.invalid-feedback');

        const candidateForm = qs('candidateForm');
        const btnFindExistingMatches = qs('btnFindExistingMatches');
        const btnUpdateAndFind = qs('btnUpdateAndFind');
        const btnRegisterAndFind = qs('btnRegisterAndFind');

        const recommendationsSection = qs('recommendationsSection');
        const recommendationsContainer = qs('recommendationsContainer');
        const loadingSection = qs('loadingSection');

        let currentMode = '';            // existing | create
        let originalProfile = null;
        let lastRecommendations = [];
        let currentDetails = null;
        const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));      // for change detection on existing

        let recDelegationBound = false; // prevent duplicate listeners for rec details
        const btnViewShortlist = document.getElementById('btnViewShortlist');
        const shortBadge = document.getElementById('shortBadge');
        const shortlistDrawerEl = document.getElementById('shortlistDrawer');
        const shortlistDrawer = new bootstrap.Offcanvas(shortlistDrawerEl);

        function getCurrentEmail() {
            return (qs('email')?.value || qs('emailLookup')?.value || '').trim();
        }

        async function refreshShortlistCount() {
            const email = getCurrentEmail();
            if (!emailRegex.test(email)) {
                btnViewShortlist.style.display = 'none';
                shortBadge.style.display = 'none';
                return;
            }
            try {
                const res = await fetch(`/api/shortlist?email=${encodeURIComponent(email)}`);
                const data = await res.json();
                let count = 0;
                if (data.success) count = (data.ids || []).length;
                btnViewShortlist.style.display = 'inline-block';
                if (count > 0) {
                    shortBadge.textContent = count;
                    shortBadge.style.display = 'inline-block';
                } else {
                    shortBadge.style.display = 'none';
                }
            } catch {
                btnViewShortlist.style.display = 'inline-block';
                shortBadge.style.display = 'none';
            }
        }

        window._shortlistItems = [];

        function renderShortlistItems(items) {
            const list = document.getElementById('shortlistList');
            const empty = document.getElementById('shortlistEmpty');
            window._shortlistItems = items.slice();
            list.innerHTML = '';
            if (!items.length) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';
            items.forEach(it => {
                const row = document.createElement('button');
                row.type = 'button';
                row.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-start shortlist-item';
                row.dataset.id = it.id;
                row.innerHTML = `
            <div class="me-2 text-start">
                <div class="fw-bold text-primary">${it.title}</div>
                <div class="small text-warning-emphasis">${it.company} • ${it.location} • ${it.sector}</div>
            </div>
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-success-subtle text-success-emphasis border border-success-subtle">₹${(it.stipend || 0).toLocaleString()}</span>
                <button class="btn btn-sm btn-outline-danger btn-unshortlist" title="Remove">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
                list.appendChild(row);
            });
        }

        async function openShortlistDrawer() {
            const email = getCurrentEmail();
            if (!emailRegex.test(email)) { showToast('warning', 'Enter a valid email first'); return; }
            try {
                const res = await fetch(`/api/shortlist?email=${encodeURIComponent(email)}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed to load shortlist');
                renderShortlistItems(data.items || []);
                shortlistDrawer.show();
            } catch (e) {
                showToast('error', e.message || 'Failed to load shortlist');
            }
        }

        btnViewShortlist.addEventListener('click', openShortlistDrawer);

        document.getElementById('shortlistList').addEventListener('click', async (ev) => {
            const row = ev.target.closest('.shortlist-item');
            if (!row) return;
            const email = getCurrentEmail();
            const id = Number(row.dataset.id);
            if (ev.target.closest('.btn-unshortlist')) {
                try {
                    const res = await fetch('/api/shortlist', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, internship_id: id })
                    });
                    const data = await res.json();
                    if (!data.success) throw new Error(data.error || 'Failed');
                    showToast('info', 'Removed from shortlist');
                    await openShortlistDrawer(); // reload list
                    await refreshShortlistCount();
                    await updateShortlistButtonState(); // sync details button if modal open
                } catch (e) {
                    showToast('error', e.message || 'Remove failed');
                }
                return;
            }
            // Open details modal for this shortlist item
            let item = (window._shortlistItems || []).find(it => Number(it.id) === id) || {};
            let rec = null;
            try {
                const r = await fetch(`/api/recommendations/by-email?email=${encodeURIComponent(email)}`);
                const data = await r.json();
                if (data.success) rec = (data.recommendations || []).find(r => (r.internship || {}).id === id) || null;
            } catch { }
            // Fill modal (reusing your code path)
            qs('mdTitle').textContent = item.title || 'Internship';
            qs('mdCompany').textContent = item.company || '';
            qs('mdSector').textContent = item.sector ? `Sector: ${item.sector}` : '';
            qs('mdLocation').textContent = item.location || '-';
            qs('mdEducation').textContent = item.education_level || '-';
            qs('mdDuration').textContent = `${item.duration_months || '-'} months`;
            qs('mdStipend').textContent = `₹${(item.stipend || 0).toLocaleString()}/month`;
            qs('mdCapacity').textContent = `${item.capacity || '-'} positions`;
            qs('mdBadges').innerHTML = `
        ${item.rural_friendly ? '<span class="badge rural-friendly"><i class="fas fa-tree"></i> Rural Friendly</span>' : ''}
        ${item.diversity_focused ? '<span class="badge diversity-badge"><i class="fas fa-users"></i> Diversity Focused</span>' : ''}
    `;
            qs('mdSkills').innerHTML = (item.skills_required || []).map(s => `<span class="chip">${s}</span>`).join('');
            qs('mdReasons').innerHTML = (rec && rec.match_reasons && rec.match_reasons.length)
                ? rec.match_reasons.map(r => `<div><i class="fas fa-check"></i> ${r}</div>`).join('')
                : '<div class="text-primary-emphasis">Saved in your shortlist</div>';
            currentDetails = { email, internshipId: item.id, rec };
            await updateShortlistButtonState();
            detailsModal.show();
        });

        // Toast utility
        function showToast(type, message, delay = 2500) {
            const container = qs('toastContainer');
            const id = 't_' + Date.now();
            const colors = {
                success: 'text-bg-success',
                error: 'text-bg-danger',
                info: 'text-bg-primary',
                warning: 'text-bg-warning'
            };
            const cls = colors[type] || colors.info;
            const html = `
              <div id="${id}" class="toast align-items-center ${cls} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="${delay}">
                <div class="d-flex">
                  <div class="toast-body">${message}</div>
                  <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
              </div>`;
            container.insertAdjacentHTML('beforeend', html);
            const el = document.getElementById(id);
            const t = new bootstrap.Toast(el);
            t.show();
            el.addEventListener('hidden.bs.toast', () => el.remove());
        }

        // Profile helpers
        const profileFromForm = () => ({
            name: qs('name').value.trim(),
            email: qs('email').value.trim(),
            education_level: qs('education_level').value,
            skills: toArray(qs('skills').value),
            location: qs('location').value,
            sector_interests: toArray(qs('sector_interests').value),
            social_category: qs('social_category').value,
            prefers_rural: qs('prefers_rural').checked,
            from_rural_area: qs('from_rural_area').checked,
            first_generation_graduate: qs('first_generation_graduate').checked
        });

        const fillForm = (c) => {
            qs('name').value = c.name || '';
            qs('email').value = c.email || '';
            qs('education_level').value = c.education_level || '';
            qs('skills').value = (c.skills || []).join(', ');
            qs('location').value = c.location || '';
            qs('sector_interests').value = (c.sector_interests || []).join(', ');
            qs('social_category').value = c.social_category || '';
            qs('prefers_rural').checked = !!c.prefers_rural;
            qs('from_rural_area').checked = !!c.from_rural_area;
            qs('first_generation_graduate').checked = !!c.first_generation_graduate;
        };

        const isChanged = (a, b) => JSON.stringify(a) !== JSON.stringify(b);

        function showDetailsForm(show) { candidateForm.style.display = show ? 'block' : 'none'; candidateForm.style.padding = show ? '10px' : '0px'; }
        function showEmailStep(show) { emailStep.style.display = show ? 'block' : 'none'; }
        function resetActionButtons() {
            btnFindExistingMatches.style.display = 'none';
            btnUpdateAndFind.style.display = 'none';
            btnRegisterAndFind.style.display = 'none';
        }
        function setActionButtons({ existing, changed, creating }) {
            resetActionButtons();
            if (creating) { btnRegisterAndFind.style.display = 'inline-block'; return; }
            if (existing && !changed) { btnFindExistingMatches.style.display = 'inline-block'; }
            else if (existing && changed) { btnUpdateAndFind.style.display = 'inline-block'; }
        }

        // Live lookup
        async function lookupByEmail(email) {
            const res = await fetch(`/api/candidates/lookup?email=${encodeURIComponent(email)}`);
            return await res.json();
        }

        emailLookup.addEventListener('input', debounce(async () => {
            const email = emailLookup.value.trim();

            // Clear UI when too short
            if (email.length < 10) {
                emailLookup.classList.remove('is-invalid', 'is-valid');
                lookupStatus.textContent = '';
                lookupSpinner.style.display = 'none';
                btnShowRecord.style.display = 'none';
                btnCreateRecord.style.display = 'none';
                showDetailsForm(false);
                return;
            }

            // Validate email format before lookup
            if (!emailRegex.test(email)) {
                emailLookup.classList.add('is-invalid');
                emailLookup.classList.remove('is-valid');
                lookupStatus.innerHTML = `<span class="text-warning">Invalid email format</span>`;
                invalidFeedback.style.display = 'block';
                btnShowRecord.style.display = 'none';
                btnCreateRecord.style.display = 'none';
                return;
            } else {
                emailLookup.classList.remove('is-invalid');
                emailLookup.classList.add('is-valid');
                invalidFeedback.style.display = 'none';
            }

            // Show spinner and perform lookup
            lookupSpinner.style.display = 'inline-block';
            try {
                const result = await lookupByEmail(email);
                const count = result.success ? (result.count || 0) : 0;
                lookupStatus.textContent = `${count} record${count === 1 ? '' : 's'} found`;
                lookupStatus.classList.remove('text-danger', 'text-warning');
                if (count > 0) {
                    lookupStatus.classList.remove('text-muted', 'text-danger-emphasis');
                    lookupStatus.classList.add('text-success');
                } else {
                    lookupStatus.classList.remove('text-success', 'text-success');
                    lookupStatus.classList.add('text-danger-emphasis');
                }

                if (!result.success) {
                    btnShowRecord.style.display = 'none';
                    btnCreateRecord.style.display = 'none';
                    showToast('error', result.error || 'Lookup failed');
                    return;
                }

                if (result.exists) {
                    btnShowRecord.style.display = 'inline-block';
                    btnCreateRecord.style.display = 'none';
                    btnShowRecord.onclick = () => {
                        currentMode = 'existing';
                        showEmailStep(false);
                        btnShowRecord.style.display = 'none';
                        btnChangeEmail.style.display = 'inline-block';

                        showDetailsForm(true);
                        fillForm(result.candidate || {});
                        originalProfile = profileFromForm();
                        setActionButtons({ existing: true, changed: false, creating: false });
                        showToast('success', 'Record loaded');

                        // Always bring view to top when form opens
                        window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
                        refreshShortlistCount();
                    };
                } else {
                    btnShowRecord.style.display = 'none';
                    btnCreateRecord.style.display = 'inline-block';
                    btnCreateRecord.onclick = () => {
                        currentMode = 'create';
                        showEmailStep(false);
                        btnCreateRecord.style.display = 'none';
                        btnChangeEmail.style.display = 'inline-block';

                        showDetailsForm(true);
                        fillForm({
                            email,
                            name: '',
                            education_level: '',
                            skills: [],
                            location: '',
                            sector_interests: [],
                            social_category: '',
                            prefers_rural: false,
                            from_rural_area: false,
                            first_generation_graduate: false
                        });
                        originalProfile = profileFromForm();
                        setActionButtons({ existing: false, changed: true, creating: true });
                        showToast('info', 'Create a new record');

                        // Always bring view to top when form opens
                        window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });
                        refreshShortlistCount();
                    };
                }
            } catch (e) {
                lookupStatus.innerHTML = `<span class="text-danger">Lookup failed</span>`;
                btnShowRecord.style.display = 'none';
                btnCreateRecord.style.display = 'none';
                showToast('error', 'Network error during lookup');
            } finally {
                lookupSpinner.style.display = 'none';
            }
        }, 350));

        // Change Email: return to email step
        btnChangeEmail.addEventListener('click', () => {
            showDetailsForm(false);
            btnViewShortlist.style.display = 'none';
            shortBadge.style.display = 'none';
            try { shortlistDrawer.hide(); } catch (e) { }
            recommendationsSection.style.display = 'none';
            btnChangeEmail.style.display = 'none';
            resetActionButtons();
            showEmailStep(true);

            // Return view to top for the search step
            window.scrollTo({ top: 0, left: 0, behavior: 'smooth' });

            // Trigger lookup again for the current value (if any)
            const ev = new Event('input');
            emailLookup.dispatchEvent(ev);
        });

        // Change detection
        candidateForm.addEventListener('input', () => {
            if (currentMode !== 'existing') return;
            const now = profileFromForm();
            const changed = isChanged(originalProfile, now);
            setActionButtons({ existing: true, changed, creating: false });
        });

        // Actions
        btnFindExistingMatches.addEventListener('click', async () => {
            const email = qs('email').value.trim();
            if (!emailRegex.test(email)) { showToast('warning', 'Enter a valid email'); return; }
            loadingSection.style.display = 'block';
            recommendationsSection.style.display = 'none';
            try {
                const res = await fetch(`/api/recommendations/by-email?email=${encodeURIComponent(email)}`);
                const result = await res.json();
                if (result.success) {
                    displayRecommendations(result.recommendations);
                } else {
                    showError(result.error || 'Could not fetch recommendations.');
                }
            } catch {
                showError('Network error. Please try again.');
            } finally {
                loadingSection.style.display = 'none';
            }
        });

        btnUpdateAndFind.addEventListener('click', async () => {
            const payload = profileFromForm();
            if (!emailRegex.test(payload.email)) { showToast('warning', 'Enter a valid email'); return; }
            loadingSection.style.display = 'block';
            recommendationsSection.style.display = 'none';
            try {
                const up = await fetch('/api/candidates/update', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const updated = await up.json();
                if (!updated.success) {
                    showToast('error', updated.error || 'Update failed.');
                    loadingSection.style.display = 'none';
                    return;
                }
                showToast('success', 'Profile updated');
                const res = await fetch(`/api/recommendations/by-email?email=${encodeURIComponent(payload.email)}`);
                const result = await res.json();
                if (result.success) {
                    // baseline reset
                    originalProfile = profileFromForm();
                    setActionButtons({ existing: true, changed: false, creating: false });
                    displayRecommendations(result.recommendations);
                } else {
                    showError(result.error || 'Could not fetch recommendations.');
                }
            } catch {
                showToast('error', 'Network error. Please try again.');
            } finally {
                loadingSection.style.display = 'none';
            }
        });

        btnRegisterAndFind.addEventListener('click', async () => {
            const payload = profileFromForm();
            if (!emailRegex.test(payload.email)) { showToast('warning', 'Enter a valid email'); return; }
            loadingSection.style.display = 'block';
            recommendationsSection.style.display = 'none';
            try {
                const res = await fetch('/api/recommendations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await res.json();
                if (result.success) {
                    showToast('success', 'Registered successfully');
                    displayRecommendations(result.recommendations);
                    refreshShortlistCount();
                } else {
                    showToast('error', result.error || 'Registration failed.');
                }
            } catch {
                showToast('error', 'Network error. Please try again.');
            } finally {
                loadingSection.style.display = 'none';
            }
        });

        // Renderers
        function displayRecommendations(recommendations) {
            lastRecommendations = recommendations.slice();
            const fmtMoney = (n) => `₹${(n || 0).toLocaleString()}/month`;
            const pct = (x) => Math.max(0, Math.min(100, Math.round((x || 0) * 100)));

            recommendationsContainer.innerHTML = '';
            if (!recommendations || recommendations.length === 0) {
                recommendationsContainer.innerHTML = '<div class="alert alert-warning mb-0">No matching internships found. Please try adjusting your preferences.</div>';
                recommendationsSection.style.display = 'block';
                return;
            }

            if (!recDelegationBound) {
                recommendationsContainer.addEventListener('click', async (ev) => {
                    const btn = ev.target.closest('.btn-view-details');
                    if (!btn) return;
                    const idx = Number(btn.dataset.index || -1);
                    if (idx < 0 || !lastRecommendations[idx]) return;

                    const rec = lastRecommendations[idx];
                    const i = rec.internship || {};
                    const reasons = rec.match_reasons || [];

                    qs('mdTitle').textContent = i.title || 'Internship';
                    qs('mdCompany').textContent = i.company || '';
                    qs('mdSector').textContent = i.sector ? `Sector: ${i.sector}` : '';
                    qs('mdLocation').textContent = i.location || '-';
                    qs('mdEducation').textContent = i.education_level || '-';
                    qs('mdDuration').textContent = `${i.duration_months || '-'} months`;
                    qs('mdStipend').textContent = `₹${(i.stipend || 0).toLocaleString()}/month`;
                    qs('mdCapacity').textContent = `${i.capacity || '-'} positions`;

                    qs('mdBadges').innerHTML = `
            ${i.rural_friendly ? '<span class="badge rural-friendly"><i class="fas fa-tree"></i> Rural Friendly</span>' : ''}
            ${i.diversity_focused ? '<span class="badge diversity-badge"><i class="fas fa-users"></i> Diversity Focused</span>' : ''}
        `;
                    qs('mdSkills').innerHTML = (i.skills_required || []).map(s => `<span class="chip">${s}</span>`).join('');
                    qs('mdReasons').innerHTML = reasons.length
                        ? reasons.map(r => `<div><i class="fas fa-check"></i> ${r}</div>`).join('')
                        : '<div class="text-muted">Balanced fit across multiple factors</div>';

                    const email = getCurrentEmail();
                    currentDetails = { email, internshipId: i.id, rec };
                    await updateShortlistButtonState();
                    detailsModal.show();
                });
                recDelegationBound = true;
            }

            recommendations.forEach(rec => {
                const i = rec.internship || {};
                const s = rec.scores || {};
                const reasons = rec.match_reasons || [];
                const matchPct = pct(s.overall);

                const card = document.createElement('div');
                card.className = 'recommendation-card';

                card.innerHTML = `
            <div class="rec-top">
                <div class="d-flex flex-column align-items-start gap-2">
                    <span class="match-score"><i class="fas fa-percentage"></i> ${matchPct}% Match</span>
                    <div class="rec-meter">
                        <div class="meter"><div class="fill" style="width:${matchPct}%"></div></div>
                    </div> 
                </div>
                <div class="rec-badges">
                    ${i.rural_friendly ? '<span class="badge rural-friendly"><i class="fas fa-tree"></i> Rural Friendly</span>' : ''}
                    ${i.diversity_focused ? '<span class="badge diversity-badge"><i class="fas fa-users"></i> Diversity Focused</span>' : ''}
                </div>
            </div>

            <div class="rec-title">
                <div class="company-name">${i.company || ''}</div>
                <div class="internship-title">${i.title || ''}</div>
            </div>

            <div class="rec-meta">
                <div><strong><i class="fas fa-map-marker-alt"></i> Location:</strong> ${i.location || '-'}</div>
                <div><strong><i class="fas fa-graduation-cap"></i> Education:</strong> ${i.education_level || '-'}</div>
                <div><strong><i class="fas fa-calendar"></i> Duration:</strong> ${i.duration_months || '-'} months</div>
                <div><strong><i class="fas fa-building"></i> Sector:</strong> ${i.sector || '-'}</div>
                <div><strong><i class="fas fa-rupee-sign"></i> Stipend:</strong> ${fmtMoney(i.stipend)}</div>
                <div><strong><i class="fas fa-users"></i> Capacity:</strong> ${i.capacity || '-'} positions</div>
            </div>

            <div class="skills-tags">
                <strong>Required Skills:</strong><br/>
                ${(i.skills_required || []).map(skill => `<span class="chip">${skill}</span>`).join('')}
            </div>

            <div class="match-reasons">
                <h6><i class="fas fa-lightbulb"></i> Why This Match?</h6>
                ${reasons.length ? reasons.map(r => `<div><i class="fas fa-check"></i> ${r}</div>`).join('') : '<div class="text-muted">Balanced fit across multiple factors</div>'}
            </div>

            <div class="rec-actions">
                <button class="btn btn-outline-primary btn-sm btn-view-details" data-index="${recommendationsContainer.children.length}">
                     <i class="fas fa-info-circle"></i> View Details
                </button>
                <button class="btn btn-success btn-sm">
                    <i class="fas fa-paper-plane"></i> Apply Now
                </button>
            </div>
        `;

                recommendationsContainer.appendChild(card);
            });

            recommendationsSection.style.display = 'block';
        }

        async function isShortlisted(email, internshipId) {
            if (!email || !internshipId) return false;
            try {
                const res = await fetch(`/api/shortlist?email=${encodeURIComponent(email)}`);
                const data = await res.json();
                if (!data.success) return false;
                return (data.ids || []).includes(Number(internshipId));
            } catch { return false; }
        }

        async function updateShortlistButtonState() {
            const btn = qs('btnShortlist');
            const { email, internshipId } = currentDetails || {};
            const saved = await isShortlisted(email, internshipId);
            btn.dataset.saved = saved ? '1' : '0';
            btn.innerHTML = saved
                ? '<i class="fas fa-bookmark"></i> Saved'
                : '<i class="fas fa-bookmark"></i> Save to Shortlist';
            btn.classList.toggle('btn-success', saved);
            btn.classList.toggle('btn-outline-primary', !saved);
        }

        qs('btnShortlist').addEventListener('click', async () => {
            const btn = qs('btnShortlist');
            const { email, internshipId } = currentDetails || {};
            if (!email || !internshipId) {
                showToast('warning', 'Email or internship is missing');
                return;
            }
            const saved = (btn.dataset.saved === '1');
            try {
                const res = await fetch('/api/shortlist', {
                    method: saved ? 'DELETE' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, internship_id: internshipId })
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Failed');
                showToast(saved ? 'info' : 'success', saved ? 'Removed from shortlist' : 'Saved to shortlist');
                await updateShortlistButtonState();
                await refreshShortlistCount();
            } catch (e) {
                showToast('error', e.message || 'Shortlist action failed');
            }
        });

        function showError(message) {
            recommendationsContainer.innerHTML = `<div class="alert alert-danger">${message}</div>`;
            recommendationsSection.style.display = 'block';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await i18n.bootstrapLang();
            // Initialize UI state
            showDetailsForm(false);
            showEmailStep(true);
            btnChangeEmail.style.display = 'none';
            resetActionButtons();
            recommendationsSection.style.display = 'none';
            loadingSection.style.display = 'none';
            btnViewShortlist.style.display = 'none';
            shortBadge.style.display = 'none';
        });
    </script>
</body>

</html>